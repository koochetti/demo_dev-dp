pipeline
{
    agent {label 'label_name' }
     environment 
	 {
        GIT_SHA_SHORT="${GIT_COMMIT[0..6]}"
     }

    stages 
	{
      stage('Checking out demo-common') 
	  {
        steps 
		{
            sh 'mkdir -p demo-common'
            dir('demo-common')
			{
				checkout changelog: false, poll: false , scm: [$class: 'GitSCM', branches: [[name: 'refs/remotes/origin/demo-common']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'e0d93970-9f7c-46b2-84e3-a32689425', url: 'https://github.com/koochetti/demo-common.git']]]
			}
            dir('demo-common')
			{
               echo "Building demo-common"
               sh 'mvn clean install'
            }
        }
      }
      stage('Checking out demo-test') 
	  {
        steps
		{
            sh 'mkdir -p demo-test'
            dir('demo-test')
			{
			
				checkout changelog: false, poll: false , scm: [$class: 'GitSCM', branches: [[name: 'refs/remotes/origin/demo-test']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'e0d93970-9f7c-46b2-84e3-a32689425', url: 'https://github.com/koochetti/demo-test.git']]]
            }
            dir('demo-test')
			{
               echo "Building demo-test"
               sh 'mvn clean install'
            }
        }
      }
      stage('BUILD') 
	  {
        steps 
		{
          echo "Git commit sha is ${GIT_SHA_SHORT}"
          echo "Building the code"
        }
      }
      stage('INTEGERATION TEST') 
	  {
        steps
		{
            sh 'echo "run integeration tests here"'
        }
      }
      stage('DOCKER BUILD') 
	  {
        steps {
          withCredentials([usernamePassword(credentialsId: 'dp', usernameVariable: 'USER', passwordVariable: 'PASSWORD')])
			{
				sh '''
				sudo docker login -u $USER -p $PASSWORD https://docker.io/
				sudo docker build -t docker.io/koochetti/demo_dev:${GIT_SHA_SHORT} .
				sudo docker push docker.io/koochetti/demo_dev:${GIT_SHA_SHORT}

				'''
			}
        }
      }	
				
			
      stage('DEPLOY TO DEV ENV') {
        steps {
                    timeout(time: 5, unit: 'MINUTES'){
                  echo "Checking out deps variables"
                  dir('./deps-variables'){
                        checkout changelog: false, poll: false ,
                        scm: [$class: 'GitSCM', branches: [[name: 'refs/remotes/origin/deps']],
                        userRemoteConfigs: [[credentialsId: 'e0d93970-9f7c-46b2-84e3-a32485695',
                        url: 'git@bitbucket.org:test/deps-variables.git']]]
                        echo "Deploying to mesos"
                    	}
		   }
                     
             }
      }
      
    }
}






    